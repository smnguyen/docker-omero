version: '2.1'
services:
  omero-data:
    container_name: omero-data
    image: omero-base
    volumes:
      - ${OMERO_DATA_DIR-~/data_omero}:/data:Z
    command: "true"

  omero-init-db:
    container_name: omero-init-db
    build: omero-init-db
    volumes_from:
      - omero-data
    depends_on:
      - omero-data

  omero-pg:
    container_name: omero-pg
    image: postgres:9.4.10
    restart: "on-failure:10"
    env_file:
      - postgres.env
    environment:
      PGDATA: /data/postgres
    volumes:
      - ./omero-postgres/init_db.sh:/docker-entrypoint-initdb.d/init_db.sh
    volumes_from:
      - omero-data
    depends_on:
      - omero-data
      - omero-init-db

  omero-server:
    container_name: omero-server
    build: omero-server
    restart: "on-failure:10"
    env_file:
      - postgres.env
    links:
      - omero-pg
    ports:
      - "${OMERO_SERVER_PORT-4064}:4064"
    volumes_from:
      - omero-data
    depends_on:
      - omero-data
      - omero-pg

  omero-web:
    container_name: omero-web
    build: omero-web
    restart: "on-failure:10"
    environment:
      OMERO_WEB_USE_SSL: "${OMERO_WEB_USE_SSL-no}"
      OMERO_WEB_DEVELOPMENT: "${OMERO_WEB_DEVELOPMENT-no}"
    links:
      - omero-server
    ports:
      - "${OMERO_WEB_PORT-80}:80"
      - "${OMERO_WEB_PORT_SSL-443}:443"
      - "${OMERO_WEB_PORT_DEVELOPMENT-4080}:4080"
    volumes_from:
      - omero-data
    depends_on:
      - omero-data
      - omero-server
